<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Capsule Dashboard</title>
    <!-- Add Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../stylesheets/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Remove the icons.js script since we're using CDN -->
</head>
<body>
<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-time-capsule"></i>
            <h2>Time Capsule</h2>
        </div>
        <nav>
            <ul>
                <li class="active"><i class="fas fa-home"></i> <span>Dashboard</span></li>
                <li><i class="fas fa-capsules"></i> <span>My Capsules</span></li>
                <li><i class="fas fa-calendar"></i> <span>Schedule</span></li>
                <li><i class="fas fa-chart-line"></i> <span>Analytics</span></li>
                <li><i class="fas fa-envelope"></i> <span>Messages</span></li>
                <li><i class="fas fa-users"></i> <span>Groups</span></li>
                <li><i class="fas fa-cog"></i> <span>Settings</span></li>
            </ul>
        </nav>
        <div class="user-profile">
            <div class="profile-image">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="profile-info">
                <h3 class="user-name">Loading...</h3>
                <p class="user-email">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <header>
            <div class="header-content">
                <h1>Welcome Back!</h1>
                <p>Manage your memories and future messages</p>
            </div>
            <div class="header-actions">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search capsules...">
                </div>
                <div class="notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </div>
                <div class="date-display">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="current-date"></span>
                </div>
            </div>
        </header>

        <!-- Create New Capsule Button -->
        <div class="create-capsule-section">
            <button class="create-capsule-btn" id="createCapsuleBtn">
                <i class="fas fa-plus"></i>
                Create New Time Capsule
            </button>
        </div>

        <!-- Category Section -->
        <div class="category-section">
            <h2>Categories</h2>
            <div class="category-grid">
                <div class="category-card" data-category="personal">
                    <i class="fas fa-rocket"></i>
                    <h3>Personal Reflection</h3>
                    <p>Write messages to your future self</p>
                    <span class="capsule-count" id="personal-count">0 capsules</span>
                </div>
                <div class="category-card" data-category="special">
                    <i class="fas fa-gift"></i>
                    <h3>Special Occasions</h3>
                    <p>Capture moments from special events</p>
                    <span class="capsule-count" id="special-count">0 capsules</span>
                </div>
                <div class="category-card" data-category="academic">
                    <i class="fas fa-graduation-cap"></i>
                    <h3>Academic Growth</h3>
                    <p>Track your educational journey</p>
                    <span class="capsule-count" id="academic-count">0 capsules</span>
                </div>
                <div class="category-card" data-category="mental">
                    <i class="fas fa-heart"></i>
                    <h3>Mental Health</h3>
                    <p>Express and track your emotions</p>
                    <span class="capsule-count" id="mental-count">0 capsules</span>
                </div>
                <div class="category-card" data-category="business">
                    <i class="fas fa-chart-line"></i>
                    <h3>Business Goals</h3>
                    <p>Track your professional growth</p>
                    <span class="capsule-count" id="business-count">0 capsules</span>
                </div>
                <div class="category-card" data-category="legacy">
                    <i class="fas fa-history"></i>
                    <h3>Legacy</h3>
                    <p>Preserve memories for future generations</p>
                    <span class="capsule-count" id="legacy-count">0 capsules</span>
                </div>
                <div class="category-card" data-category="social">
                    <i class="fas fa-users"></i>
                    <h3>Social</h3>
                    <p>Share moments with friends</p>
                    <span class="capsule-count" id="social-count">0 capsules</span>
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="stats-section">
            <div class="stat-card">
                <i class="fas fa-capsules"></i>
                <div class="stat-info">
                    <h3>Total Capsules</h3>
                    <p id="total-capsules">0</p>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-calendar-alt"></i>
                <div class="stat-info">
                    <h3>Scheduled</h3>
                    <p id="scheduled-capsules">0</p>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-envelope"></i>
                <div class="stat-info">
                    <h3>Delivered</h3>
                    <p id="delivered-capsules">0</p>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-clock"></i>
                <div class="stat-info">
                    <h3>Upcoming</h3>
                    <p id="upcoming-capsules">0</p>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="content-section">
            <div class="section-header">
                <h2>Recent Activity</h2>
                <div class="section-actions">
                    <button class="filter-btn"><i class="fas fa-filter"></i> Filter</button>
                    <a href="/capsules-view" class="view-all">View All</a>
                </div>
            </div>
            <div class="activity-list" id="recentActivity">
                <!-- Activity items will be dynamically added here -->
            </div>
        </div>

        <!-- Upcoming Capsules -->
        <div class="content-section">
            <div class="section-header">
                <h2>Upcoming Capsules</h2>
                <div class="section-actions">
                    <button class="sort-btn"><i class="fas fa-sort"></i> Sort</button>
                    <a href="/capsules-view" class="view-all">View All</a>
                </div>
            </div>
            <div class="capsule-grid" id="upcomingCapsules">
                <!-- Capsule cards will be dynamically added here -->
            </div>
        </div>
    </div>
</div>

<!-- Create Capsule Modal -->
<div class="modal" id="createCapsuleModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Time Capsule</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="createCapsuleForm">
                <div class="form-group">
                    <label for="capsuleCategory">Category</label>
                    <select id="capsuleCategory" required>
                        <option value="">Select a category</option>
                        <option value="personal">Personal Reflection</option>
                        <option value="special">Special Occasions</option>
                        <option value="academic">Academic Growth</option>
                        <option value="mental">Mental Health</option>
                        <option value="business">Business Goals</option>
                        <option value="legacy">Legacy</option>
                        <option value="social">Social</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="capsuleTitle">Capsule Title</label>
                    <input type="text" id="capsuleTitle" placeholder="Enter title for your capsule" required>
                </div>
                <div class="form-group">
                    <label for="capsuleMessage">Your Message</label>
                    <textarea id="capsuleMessage" placeholder="Write your message..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="capsuleDate">Schedule Date</label>
                    <input type="datetime-local" id="capsuleDate" required>
                </div>
                <div class="form-group files-group">
                    <label for="capsuleFiles">Add Media</label>
                    <div class="file-upload">
                        <input type="file" id="capsuleFiles" multiple accept="image/*,video/*,audio/*">
                        <label for="capsuleFiles" class="file-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Upload files</span>
                        </label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn">Cancel</button>
                    <button type="submit" class="submit-btn">Create Capsule</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Settings</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="settingsForm">
                <div class="form-group">
                    <label for="userName">Display Name</label>
                    <input type="text" id="userName" value="User Name">
                </div>
                <div class="form-group">
                    <label for="userEmail">Email</label>
                    <input type="email" id="userEmail" value="user@example.com">
                </div>
                <div class="form-group">
                    <label for="userPassword">New Password</label>
                    <input type="password" id="userPassword" placeholder="Leave blank to keep current password">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="emailNotifications" checked>
                        <span>Email Notifications</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="darkMode">
                        <span>Dark Mode</span>
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn">Cancel</button>
                    <button type="submit" class="submit-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Footer -->
<footer>
    <p>© 2025 Time Capsule. All rights reserved.</p>
</footer>

<script>
    // Store capsules in localStorage
    let capsules = JSON.parse(localStorage.getItem('capsules')) || [];

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize capsules from localStorage or as empty array
        window.capsules = JSON.parse(localStorage.getItem('capsules')) || [];
        
        // Check authentication first
        if (!checkAuth()) return;

        // Update user profile
        updateUserProfile();

        // Initial fetch of capsules
        fetchAndUpdateCapsules();

        // Modal functionality
        const createCapsuleBtn = document.getElementById('createCapsuleBtn');
        const modal = document.getElementById('createCapsuleModal');
        const closeModal = document.querySelector('.close-modal');
        const cancelBtn = document.querySelector('.cancel-btn');
        const createCapsuleForm = document.getElementById('createCapsuleForm');

        // Open modal when clicking create button
        createCapsuleBtn.addEventListener('click', function() {
            modal.style.display = 'block';
        });

        // Close modal when clicking close button or cancel
        closeModal.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        cancelBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Form submission
        createCapsuleForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get current user from localStorage
            const currentUser = JSON.parse(localStorage.getItem('user'));
            if (!currentUser || !currentUser._id) {
                alert('Please log in to create a capsule');
                window.location.href = '/login';
                return;
            }
            
            const formData = new FormData();
            formData.append('title', document.getElementById('capsuleTitle').value);
            formData.append('message', document.getElementById('capsuleMessage').value);
            formData.append('category', document.getElementById('capsuleCategory').value);
            formData.append('scheduleDate', document.getElementById('capsuleDate').value);
            formData.append('creator', currentUser._id);

            // Add files if any
            const fileInput = document.getElementById('capsuleFiles');
            if (fileInput.files.length > 0) {
                for (let i = 0; i < fileInput.files.length; i++) {
                    formData.append('files', fileInput.files[i]);
                }
            }

            try {
                const response = await fetch('/api/capsules/create', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create capsule');
                }

                // Close modal and refresh capsules
                document.getElementById('createCapsuleModal').style.display = 'none';
                document.getElementById('createCapsuleForm').reset();
                await fetchAndUpdateCapsules();
                
                // Show success message
                alert('Capsule created successfully!');
            } catch (error) {
                console.error('Error creating capsule:', error);
                alert(error.message || 'Failed to create capsule. Please try again.');
            }
        });

        // Add date input validation
        const capsuleDateInput = document.getElementById('capsuleDate');
        if (capsuleDateInput) {
            // Set minimum date to today
            const today = new Date();
            today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
            capsuleDateInput.min = today.toISOString().slice(0, 16);

            // Set maximum date to 100 years from now
            const maxDate = new Date();
            maxDate.setFullYear(maxDate.getFullYear() + 100);
            capsuleDateInput.max = maxDate.toISOString().slice(0, 16);

            // Add input event listener for real-time validation
            capsuleDateInput.addEventListener('input', function() {
                const selectedDate = new Date(this.value);
                const now = new Date();

                if (selectedDate <= now) {
                    this.setCustomValidity('Please select a future date');
                } else if (selectedDate > maxDate) {
                    this.setCustomValidity('Please select a date within the next 100 years');
                } else {
                    this.setCustomValidity('');
                }
            });
        }

        // Function to fetch capsules from the server
        async function fetchAndUpdateCapsules() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('user'));
                if (!currentUser || !currentUser._id) {
                    console.error('No user found in localStorage');
                    window.location.href = '/login';
                    return;
                }

                console.log('Fetching capsules for user ID:', currentUser._id);
                const response = await fetch(`/api/capsules/my-capsules?userId=${currentUser._id}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Extract capsules from the response data
                const capsules = data.capsules || [];
                console.log('Found capsules:', capsules.length, capsules);
                
                // Store capsules in localStorage and global variable
                localStorage.setItem('capsules', JSON.stringify(capsules));
                window.capsules = capsules; // Make capsules available globally
                
                // Update UI with the fetched capsules
                updateRecentActivity(capsules);
                updateUpcomingCapsules(capsules);
                updateCategoryCounts(capsules);
            } catch (error) {
                console.error('Error fetching capsules:', error);
                // Show error message in the UI
                const recentActivity = document.getElementById('recentActivity');
                const upcomingCapsules = document.getElementById('upcomingCapsules');
                
                if (recentActivity) {
                    recentActivity.innerHTML = `
                        <div class="error-message">
                            Failed to load recent activity. Please try refreshing the page.
                        </div>
                    `;
                }
                
                if (upcomingCapsules) {
                    upcomingCapsules.innerHTML = `
                        <div class="error-message">
                            Failed to load upcoming capsules. Please try refreshing the page.
                        </div>
                    `;
                }
            }
        }

        function updateRecentActivity(capsules) {
            const recentActivity = document.getElementById('recentActivity');
            if (!recentActivity) {
                console.error('Recent activity element not found');
                return;
            }

            if (!capsules || capsules.length === 0) {
                recentActivity.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>No recent activity</p>
                    </div>
                `;
                return;
            }

            console.log('Updating recent activity with capsules:', capsules);

            // Sort capsules by creation date (newest first)
            const sortedCapsules = [...capsules].sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            );

            // Take only the 5 most recent capsules
            const recentCapsules = sortedCapsules.slice(0, 5);

            recentActivity.innerHTML = recentCapsules.map(capsule => `
                <div class="activity-item">
                    <div class="activity-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="activity-content">
                        <h4>${capsule.title}</h4>
                        <p>${capsule.message.substring(0, 50)}${capsule.message.length > 50 ? '...' : ''}</p>
                        <span class="activity-date">Created: ${formatDate(capsule.createdAt)}</span>
                    </div>
                </div>
            `).join('');
        }

        function updateUpcomingCapsules(capsules) {
            const upcomingCapsules = document.getElementById('upcomingCapsules');
            if (!upcomingCapsules) {
                console.error('Upcoming capsules element not found');
                return;
            }

            if (!capsules || capsules.length === 0) {
                upcomingCapsules.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar"></i>
                        <p>No upcoming capsules</p>
                    </div>
                `;
                return;
            }

            console.log('Updating upcoming capsules with:', capsules);

            // Filter for upcoming capsules and sort by schedule date
            const upcoming = capsules
                .filter(capsule => new Date(capsule.scheduleDate) > new Date())
                .sort((a, b) => new Date(a.scheduleDate) - new Date(b.scheduleDate))
                .slice(0, 5);

            if (upcoming.length === 0) {
                upcomingCapsules.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar"></i>
                        <p>No upcoming capsules</p>
                    </div>
                `;
                return;
            }

            upcomingCapsules.innerHTML = upcoming.map(capsule => `
                <div class="upcoming-item">
                    <div class="upcoming-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="upcoming-content">
                        <h4>${capsule.title}</h4>
                        <p>${capsule.message.substring(0, 50)}${capsule.message.length > 50 ? '...' : ''}</p>
                        <span class="upcoming-date">Scheduled for: ${formatDate(capsule.scheduleDate)}</span>
                    </div>
                </div>
            `).join('');
        }

        function updateCategoryCounts(capsules) {
            const categoryCounts = {};
            capsules.forEach(capsule => {
                categoryCounts[capsule.category] = (categoryCounts[capsule.category] || 0) + 1;
            });

            // Update category counts in the cards
            const categories = ['personal', 'special', 'academic', 'mental', 'business', 'legacy', 'social'];
            categories.forEach(category => {
                const count = categoryCounts[category] || 0;
                const countElement = document.getElementById(`${category}-count`);
                if (countElement) {
                    countElement.textContent = `${count} capsule${count !== 1 ? 's' : ''}`;
                }
            });

            // Update total stats
            document.getElementById('total-capsules').textContent = capsules.length;
            document.getElementById('scheduled-capsules').textContent = capsules.filter(c => c.status === 'pending').length;
            document.getElementById('delivered-capsules').textContent = capsules.filter(c => c.status === 'delivered').length;
            document.getElementById('upcoming-capsules').textContent = capsules.filter(c => c.status === 'pending' && new Date(c.scheduleDate) > new Date()).length;
        }

        // Function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Display current date
        const dateDisplay = document.getElementById('current-date');
        const today = new Date();
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        };
        dateDisplay.textContent = today.toLocaleDateString('en-US', options);

        // Update date display in capsule cards
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Add event listeners to category cards
        document.querySelectorAll('.category-card').forEach(card => {
            card.addEventListener('click', () => {
                const category = card.getAttribute('data-category');
                console.log('Clicked category:', category); // Debug log
                console.log('Available capsules:', capsules); // Debug log
                showCategoryCapsules(category);
            });
        });

        function showCategoryCapsules(category) {
            const capsules = window.capsules || [];
            const categoryCapsules = capsules.filter(capsule => capsule.category === category);
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content category-modal-content';
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>${category.charAt(0).toUpperCase() + category.slice(1)} Capsules</h2>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="category-capsules-grid">
                        ${categoryCapsules.length === 0 ? `
                            <div class="empty-state">
                                <i class="fas fa-folder-open"></i>
                                <p>No capsules in this category</p>
                            </div>
                        ` : categoryCapsules.map(capsule => `
                            <div class="capsule-card">
                                <div class="capsule-info">
                                    <h3>${capsule.title}</h3>
                                    <p>${capsule.message.substring(0, 100)}${capsule.message.length > 100 ? '...' : ''}</p>
                                    <div class="capsule-meta">
                                        <span class="capsule-date">
                                            <i class="fas fa-calendar"></i>
                                            ${formatDate(capsule.scheduleDate)}
                                        </span>
                                        <span class="capsule-status ${capsule.status}">
                                            ${capsule.status}
                                        </span>
                                    </div>
                                </div>
                                <div class="capsule-actions">
                                    <button class="view-btn" onclick="viewCapsule('${capsule._id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="edit-btn" onclick="editCapsule('${capsule._id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-btn" onclick="deleteCapsule('${capsule._id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Create and show modal
            const modal = document.createElement('div');
            modal.className = 'modal category-modal';
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Add styles for the category modal
            const style = document.createElement('style');
            style.textContent = `
                .category-modal {
                    display: block;
                    position: fixed;
                    z-index: 1000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    overflow-y: auto;
                }

                .category-modal-content {
                    background: white;
                    margin: 50px auto;
                    padding: 0;
                    width: 90%;
                    max-width: 1200px;
                    border-radius: 12px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                    position: relative;
                }

                .category-modal .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    border-bottom: 1px solid #eee;
                }

                .category-modal .modal-header h2 {
                    margin: 0;
                    color: #333;
                }

                .category-modal .close-modal {
                    font-size: 24px;
                    font-weight: bold;
                    color: #666;
                    cursor: pointer;
                    padding: 5px;
                }

                .category-modal .close-modal:hover {
                    color: #333;
                }

                .category-modal .modal-body {
                    padding: 20px;
                    max-height: calc(100vh - 150px);
                    overflow-y: auto;
                }

                .category-capsules-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                    gap: 20px;
                }

                .category-capsules-grid .capsule-card {
                    background: white;
                    border-radius: 10px;
                    padding: 20px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                }

                .category-capsules-grid .capsule-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                }

                @media (max-width: 768px) {
                    .category-modal-content {
                        width: 95%;
                        margin: 20px auto;
                    }

                    .category-capsules-grid {
                        grid-template-columns: 1fr;
                    }
                }
            `;
            document.head.appendChild(style);

            // Add close button functionality
            const closeBtn = modal.querySelector('.close-modal');
            closeBtn.onclick = function() {
                document.body.removeChild(modal);
                document.head.removeChild(style);
            }

            // Close modal when clicking outside
            window.onclick = function(event) {
                if (event.target == modal) {
                    document.body.removeChild(modal);
                    document.head.removeChild(style);
                }
            }
        }

        // Add search functionality
        const searchInput = document.querySelector('.search-bar input');
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            filterAndDisplayCapsules(searchTerm);
        });

        function filterAndDisplayCapsules(searchTerm) {
            // Filter capsules based on search term
            const filteredCapsules = capsules.filter(capsule => {
                return (
                    capsule.title.toLowerCase().includes(searchTerm) ||
                    capsule.message.toLowerCase().includes(searchTerm) ||
                    capsule.category.toLowerCase().includes(searchTerm)
                );
            });

            // Update the UI with filtered capsules
            updateUI(filteredCapsules);
        }

        // Settings Modal Functionality
        const settingsBtn = document.querySelector('li:has(i.fa-cog)');
        const settingsModal = document.getElementById('settingsModal');
        const settingsForm = document.getElementById('settingsForm');

        // Open settings modal
        settingsBtn.addEventListener('click', function() {
            settingsModal.style.display = 'block';
        });

        // Close settings modal
        settingsModal.querySelector('.close-modal').addEventListener('click', function() {
            settingsModal.style.display = 'none';
        });

        settingsModal.querySelector('.cancel-btn').addEventListener('click', function() {
            settingsModal.style.display = 'none';
        });

        // Handle settings form submission
        settingsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            // Here you would typically send the settings to the server
            alert('Settings saved successfully!');
            settingsModal.style.display = 'none';
        });

        // Logout functionality
        const logoutBtn = document.createElement('li');
        logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> <span>Logout</span>';
        logoutBtn.className = 'logout-btn';
        document.querySelector('.sidebar nav ul').appendChild(logoutBtn);

        logoutBtn.addEventListener('click', function() {
            // Clear any session data
            localStorage.removeItem('capsules');
            localStorage.removeItem('user');
            // Redirect to login page
            window.location.href = '/login';
        });

        // Update user profile
        updateUserProfile();

        // Add delete capsule functionality
        async function deleteCapsule(capsuleId) {
            if (!confirm('Are you sure you want to delete this capsule? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/capsules/delete/${capsuleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete capsule');
                }

                // Remove the capsule from local storage
                const capsules = JSON.parse(localStorage.getItem('capsules')) || [];
                const updatedCapsules = capsules.filter(c => c._id !== capsuleId);
                localStorage.setItem('capsules', JSON.stringify(updatedCapsules));
                window.capsules = updatedCapsules;

                // Update the UI
                await fetchAndUpdateCapsules();

                // Show success message
                alert('Capsule deleted successfully');

                // Close modal if open
                const modal = document.querySelector('.category-modal');
                if (modal) {
                    document.body.removeChild(modal);
                    const style = document.querySelector('style[data-modal-style]');
                    if (style) {
                        document.head.removeChild(style);
                    }
                }
            } catch (error) {
                console.error('Error deleting capsule:', error);
                alert(error.message || 'Failed to delete capsule. Please try again.');
            }
        }

        // Add view capsule functionality
        function viewCapsule(capsuleId) {
            const capsule = window.capsules.find(c => c._id === capsuleId);
            if (!capsule) return;

            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content view-modal-content';
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>${capsule.title}</h2>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="capsule-details">
                        <div class="capsule-meta">
                            <span class="capsule-category">${capsule.category}</span>
                            <span class="capsule-date">
                                <i class="fas fa-calendar"></i>
                                ${formatDate(capsule.scheduleDate)}
                            </span>
                            <span class="capsule-status ${capsule.status}">
                                ${capsule.status}
                            </span>
                        </div>
                        <div class="capsule-message">
                            <p>${capsule.message}</p>
                        </div>
                        ${capsule.files && capsule.files.length > 0 ? `
                            <div class="capsule-files">
                                <h3>Attached Files</h3>
                                <div class="files-grid">
                                    ${capsule.files.map(file => `
                                        <div class="file-item">
                                            ${file.mimetype.startsWith('image/') 
                                                ? `<img src="/uploads/${file.filename}" alt="${file.originalname}">`
                                                : `<i class="fas fa-file"></i>`
                                            }
                                            <span>${file.originalname}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            const modal = document.createElement('div');
            modal.className = 'modal view-modal';
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Add styles for the view modal
            const style = document.createElement('style');
            style.setAttribute('data-modal-style', '');
            style.textContent = `
                .view-modal {
                    display: block;
                    position: fixed;
                    z-index: 1000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    overflow-y: auto;
                }

                .view-modal-content {
                    background: white;
                    margin: 50px auto;
                    padding: 0;
                    width: 90%;
                    max-width: 800px;
                    border-radius: 12px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                }

                .view-modal .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    border-bottom: 1px solid #eee;
                }

                .view-modal .modal-body {
                    padding: 20px;
                }

                .capsule-details {
                    display: flex;
                    flex-direction: column;
                    gap: 20px;
                }

                .capsule-message {
                    line-height: 1.6;
                    color: #333;
                }

                .capsule-files {
                    margin-top: 20px;
                }

                .files-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                    gap: 15px;
                    margin-top: 10px;
                }

                .file-item {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 5px;
                }

                .file-item img {
                    width: 100%;
                    height: 150px;
                    object-fit: cover;
                    border-radius: 8px;
                }

                .file-item i {
                    font-size: 3em;
                    color: #666;
                }

                .file-item span {
                    font-size: 0.9em;
                    color: #666;
                    text-align: center;
                    word-break: break-word;
                }
            `;
            document.head.appendChild(style);

            // Close button functionality
            const closeBtn = modal.querySelector('.close-modal');
            closeBtn.onclick = function() {
                document.body.removeChild(modal);
                document.head.removeChild(style);
            }

            // Click outside to close
            window.onclick = function(event) {
                if (event.target == modal) {
                    document.body.removeChild(modal);
                    document.head.removeChild(style);
                }
            }
        }
    });

    // Function to update user profile information
    function updateUserProfile() {
        const currentUser = JSON.parse(localStorage.getItem('user'));
        if (currentUser) {
            // Update user name and email in the sidebar
            const userNameElement = document.querySelector('.user-name');
            const userEmailElement = document.querySelector('.user-email');
            if (userNameElement) userNameElement.textContent = currentUser.username || 'User Name';
            if (userEmailElement) userEmailElement.textContent = currentUser.email || 'user@example.com';
            
            // Update settings form
            const userNameInput = document.getElementById('userName');
            const userEmailInput = document.getElementById('userEmail');
            if (userNameInput) userNameInput.value = currentUser.username || '';
            if (userEmailInput) userEmailInput.value = currentUser.email || '';
        } else {
            // If no user data, redirect to login
            window.location.href = '/login';
        }
    }

    // Check authentication status
    function checkAuth() {
        const currentUser = JSON.parse(localStorage.getItem('user'));
        if (!currentUser || !currentUser._id) {
            window.location.href = '/login';
            return false;
        }
        return true;
    }
</script>

<style>
    /* Add these styles to your existing CSS */
    .logout-btn {
        margin-top: auto;
        color: #ff4444;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .logout-btn:hover {
        background-color: rgba(255, 68, 68, 0.1);
    }

    .logout-btn i {
        color: #ff4444;
    }

    /* Settings Modal Styles */
    #settingsModal .modal-content {
        max-width: 500px;
    }

    #settingsModal .form-group {
        margin-bottom: 20px;
    }

    #settingsModal input[type="text"],
    #settingsModal input[type="email"],
    #settingsModal input[type="password"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    #settingsModal .checkbox-label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
    }

    #settingsModal .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }

    #settingsModal .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    #settingsModal .submit-btn {
        background-color: #4CAF50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #settingsModal .submit-btn:hover {
        background-color: #45a049;
    }

    #settingsModal .cancel-btn {
        background-color: #f44336;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #settingsModal .cancel-btn:hover {
        background-color: #da190b;
    }
</style>
</body>
</html>