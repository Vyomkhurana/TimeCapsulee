const mongoose = require('mongoose');const bcrypt = require('bcryptjs');const userSchema = new mongoose.Schema({    username: {        type: String,        required: [true, 'Username is required'],        unique: true,        trim: true,        lowercase: true,        minlength: [3, 'Username must be at least 3 characters long'],        maxlength: [30, 'Username cannot be more than 30 characters'],        match: [/^[a-zA-Z0-9_]+$/, 'Username can only contain letters, numbers, and underscores'],        index: true    },    email: {        type: String,        required: [true, 'Email is required'],        unique: true,        trim: true,        lowercase: true,        match: [/^[^\s@]+@[^\s@]+\.[^\s@]+$/, 'Please enter a valid email'],        index: true    },    password: {        type: String,        required: [true, 'Password is required'],        minlength: [6, 'Password must be at least 6 characters long'],        select: false     },    terms: {        type: Boolean,        required: [true, 'Terms must be accepted'],        default: false    },    resetPasswordToken: {        type: String,        default: null,        index: { sparse: true }     },    resetPasswordExpires: {        type: Date,        default: null    },    isActive: {        type: Boolean,        default: true    },    lastLogin: {        type: Date    },    createdAt: {        type: Date,        default: Date.now,        immutable: true     }}, {    timestamps: true });userSchema.pre('save', async function(next) {    try {        if (!this.isModified('password')) return next();        const salt = await bcrypt.genSalt(12);        this.password = await bcrypt.hash(this.password, salt);        next();    } catch (error) {        next(error);    }});userSchema.methods.verifyPassword = async function(password) {    try {        return await bcrypt.compare(password, this.password);    } catch (error) {        throw new Error('Password verification failed');    }};userSchema.methods.updateLastLogin = function() {    this.lastLogin = new Date();    return this.save();};userSchema.statics.findByCredentials = async function(identifier) {    return this.findOne({        $or: [            { email: identifier.toLowerCase() },            { username: identifier.toLowerCase() }        ]    }).select('+password');};userSchema.methods.toJSON = function() {    const user = this.toObject();    delete user.password;    delete user.resetPasswordToken;    delete user.resetPasswordExpires;    return user;};module.exports = mongoose.model('User', userSchema);